<!DOCTYPE html>
<html>
 <head>
  <title>Are We Slim Yet?</title>
  <style type="text/css">
    .graph {
        float: left;
        width: 700px;
        height: 600px;
    }

    .detail {
        float: left;
        border: solid 1px black;
        margin-left: 10px;
    }

    td {
        padding: 2px;
    }
  </style>
 </head>
 <body>
  <h1>Are We Slim Yet?</h1>
  <h2>Resident memory usage</h2>
  <div id="resident-graph" class="graph">Loading...</div>
  <div id="resident-detail" class="detail"></div>
  <hr style="clear: both">
  <h2>Explicit memory usage</h2>
  <div id="explicit-graph" class="graph">Loading...</div>
  <div id="explicit-detail" class="detail"></div>
  <hr style="clear: both">

  <script src="jquery-1.7.1.min.js" type="text/javascript"></script>
  <script src="jquery.flot.min.js" type="text/javascript"></script>
  <script type="text/javascript">
    var options = {
        series: {
            lines: { show: true },
            points: { show: true }
        },
        grid: {
            clickable: true
        },
        xaxis: {
            show: true,
            tickFormatter: function(val, axis) {
                var d = new Date( val * 1000 );
                return d.toDateString();
            }
        },
        yaxis: {
            show: true,
            tickFormatter: function(val, axis) {
                return (val / 1048576).toFixed(axis.tickDecimals) + " MiB";
            }
        },
        legend: {
            position: "nw",
            margin: [0, 200]
        },
        hooks: {
            processRawData: function( plot, series, data, datapoints ) {
                var parentDiv = plot.getCanvas().parentNode;
                parentDiv._detailData[series.label] = new Array(); // each entry is an array of raw data corresponding to a displayed data point

                function dateToTimestamp( dateStr ) {
                    var year = dateStr.substring( 0, 4 );
                    var month = dateStr.substring( 4, 6 );
                    var day = dateStr.substring( 6, 8 );
                    return Date.parse( year + "-" + month + "-" + day ) / 1000;
                }

                var dateStr = null;
                var bucketStart = -1;
                var bucketValue = -1;
                var bucketRawData = null;

                var points = new Array();
                var pointsIx = 0;
                for (var i = 0; i < data.length; i++) {
                    var iterDateStr = (data[i] == null ? null : data[i][0].substring( 0, 8 ));

                    if (dateStr != null && iterDateStr != dateStr) {
                        points[ pointsIx++ ] = dateToTimestamp( dateStr );
                        points[ pointsIx++ ] = bucketValue / (i - bucketStart);
                        parentDiv._detailData[series.label].push( bucketRawData );
                        dateStr = null;
                    }

                    if (iterDateStr == null) {
                        break;
                    }

                    if (dateStr == null) {
                        dateStr = iterDateStr;
                        bucketStart = i;
                        bucketValue = data[i][1];
                        bucketRawData = new Array();
                        bucketRawData.push( data[i] );
                    } else {
                        bucketValue += data[i][1];
                        bucketRawData.push( data[i] );
                    }
                }

                datapoints.points = points;
                datapoints.pointsize = 2;
            }
        }
    };

    function showDetail( metric, divId, label, index ) {
        var detailHtml = '';
        if (label && index) {
            detailHtml = '<table><tr><th colspan="3">data series: ' + label + '</th></tr><tr><th>timestamp</th><th>' + metric + '</th><th>changeset</th></tr>';
            var detailData = document.getElementById( divId )._detailData[label][index];
            var lastCset = null;
            for (var i = 0; i < detailData.length; i++) {
                var cset = detailData[i][2].substring(detailData[i][2].lastIndexOf('/') + 1);
                var link = (lastCset != null)
                    ? 'https://hg.mozilla.org/integration/mozilla-inbound/pushloghtml?fromchange=' + lastCset + '&tochange=' + cset
                    : 'https://hg.mozilla.org/integration/mozilla-inbound/rev/' + cset;
                lastCset = cset;
                detailHtml += '<tr><td>' + detailData[i][0] + '</td><td>' + detailData[i][1] + '</td><td><a href="' + link + '">' + cset + '</a></td></tr>';
            }
            detailHtml += '</table>';
        }
        document.getElementById( metric + '-detail' ).innerHTML = detailHtml;
    }

    function load( metric ) {
        var divId = metric + "-graph";
        document.getElementById( divId )._detailData = new Array();
        var xhr = new XMLHttpRequest();
        xhr.open( "GET", metric + ".graphdata" );
        xhr.onreadystatechange = function() {
            if (this.readyState == this.DONE) {
                var data;
                if (this.status == 200 && (data = JSON.parse( this.responseText ))) {
                    $.plot( $( '#' + divId ), data, options );
                    $( '#' + divId ).bind( "plotclick", function (event, pos, item) {
                        showDetail( metric, divId, item ? item.series.label : null, item ? item.dataIndex : null );
                    } );

                    if (window.location.hash) {
                        var params = window.location.hash.substring(1).split(',');
                        var args = new Array();
                        for (var i = 0; i < params.length; i++) {
                            params[i] = params[i].split('=');
                            args[params[i][0]] = params[i][1];
                        }
                        showDetail( metric, divId, args["which"], args["when"] );
                    }
                } else {
                    document.getElementById( divId ).innerHTML = 'Error fetching graph data :(';
                }
            }
        };
        xhr.send();
    }

    load( 'resident' );
    load( 'explicit' );
  </script>
 </body>
</html>
